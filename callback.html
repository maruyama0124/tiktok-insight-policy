<!-- <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TikTok Callback</title>
</head>
<body>
  <h1>TikTok Login Callback</h1>
  <p>Received TikTok authorization parameters:</p>
  <pre id="params">loading...</pre>

  <script>
    const params = new URLSearchParams(window.location.search);
    document.getElementById('params').textContent = params.toString();
  </script>
</body>
</html> -->




<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TikTok Callback</title>
</head>
<body>
  <h2>認可コード</h2>
  <pre id="code"></pre>
  <h2>APIへ送信</h2>
  <p>
    <label for="codeInput">コード:</label>
    <textarea id="codeInput" rows="4" cols="80" placeholder="ここにコードを貼り付け"></textarea>
  </p>
  <h2>送信ステータス</h2>
  <pre id="status">waiting...</pre>
  <p>
    <button id="runBtn">送信して取得</button>
  </p>
  <p>
    <button id="loginBtn">もう一度ログインする</button>
  </p>
  <pre id="fetchStatus">未実行</pre>

  <script>
    const params = new URLSearchParams(window.location.search);
    let code = params.get("code");
    if (!code) {
      const match = window.location.href.match(/[?&]code=([^&]+)/);
      code = match ? match[1] : null;
    }
    if (code) {
      try {
        code = decodeURIComponent(code);
      } catch (err) {
        code = code;
      }
    }
    const apiBase = "https://wiggly-reguline-dane.ngrok-free.dev";
    const runBtn = document.getElementById("runBtn");
    const loginBtn = document.getElementById("loginBtn");
    const codeInput = document.getElementById("codeInput");
    const statusEl = document.getElementById("status");
    const fetchStatusEl = document.getElementById("fetchStatus");

    document.getElementById("code").innerText = code ?? "コードが見つかりません";
    if (code) {
      codeInput.value = code;
    }
    const defaultApi = apiBase;

    async function sendCode() {
      const codeValue = codeInput.value.trim();
      if (!codeValue) {
        statusEl.innerText = "コードが必要です";
        return { ok: false };
      }
      statusEl.innerText = "送信中...";
      try {
        const res = await fetch(`${apiBase}/auth/callback`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: codeValue }),
        });
        const result = await res.json().catch(() => ({}));
        const pretty = JSON.stringify(result, null, 2);
        statusEl.innerText = `完了: ${res.status}\n${pretty}`;
        return { ok: res.ok };
      } catch (err) {
        statusEl.innerText = `失敗: ${String(err)}`;
        return { ok: false };
      }
    }

    async function fetchLatest() {
      fetchStatusEl.innerText = "取得中...";
      try {
        const res = await fetch(`${apiBase}/auth/fetch-latest`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({}),
        });
        const result = await res.json().catch(() => ({}));
        const pretty = JSON.stringify(result, null, 2);
        fetchStatusEl.innerText = `完了: ${res.status}\n${pretty}`;
      } catch (err) {
        fetchStatusEl.innerText = `失敗: ${String(err)}`;
      }
    }

    async function runAll() {
      runBtn.disabled = true;
      runBtn.style.display = "none";
      const result = await sendCode();
      if (result && result.ok) {
        await fetchLatest();
      }
    }

    runBtn.addEventListener("click", runAll);

    function startLogin() {
      const authUrl = "https://www.tiktok.com/v2/auth/authorize/?client_key=sbawmzotbr0r0mm3xf&response_type=code&scope=user.info.basic%2Cuser.info.stats%2Cuser.info.profile%2Cvideo.list&redirect_uri=https%3A%2F%2Fmaruyama0124.github.io%2Ftiktok-insight-policy%2Fcallback.html&state=rebear_tiktok_insight";
      window.location.href = authUrl;
    }

    loginBtn.addEventListener("click", startLogin);
  </script>
</body>
</html>
