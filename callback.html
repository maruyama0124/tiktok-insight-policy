<!-- <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TikTok Callback</title>
</head>
<body>
  <h1>TikTok Login Callback</h1>
  <p>Received TikTok authorization parameters:</p>
  <pre id="params">loading...</pre>

  <script>
    const params = new URLSearchParams(window.location.search);
    document.getElementById('params').textContent = params.toString();
  </script>
</body>
</html> -->




<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TikTok Callback</title>
</head>
<body>
  <h2>認可コード</h2>
  <pre id="code"></pre>
  <h2>APIへ送信</h2>
  <p>1) 上のコードを確認します。</p>
  <p>2) API Base URL を入力します。</p>
  <p>3) 「APIへ送信」をクリックします。</p>
  <p>
    <label for="codeInput">コード:</label>
    <textarea id="codeInput" rows="4" cols="80" placeholder="ここにコードを貼り付け"></textarea>
  </p>
  <h2>送信ステータス</h2>
  <pre id="status">waiting...</pre>
  <p>
    <label for="apiBase">API Base URL:</label>
    <input id="apiBase" type="text" placeholder="http://localhost:8000">
    <button id="sendBtn">APIへ送信</button>
  </p>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const apiParam = params.get("api");
    const apiInput = document.getElementById("apiBase");
    const sendBtn = document.getElementById("sendBtn");
    const codeInput = document.getElementById("codeInput");
    const statusEl = document.getElementById("status");

    document.getElementById("code").innerText = code ?? "コードが見つかりません";
    if (code) {
      codeInput.value = code;
    }
    const savedApi = localStorage.getItem("tiktok_api_base");
    if (savedApi) {
      apiInput.value = savedApi;
    }

    async function sendCode(apiBase) {
      const codeValue = codeInput.value.trim();
      if (!codeValue) {
        statusEl.innerText = "コードが必要です";
        return;
      }
      if (!apiBase) {
        statusEl.innerText = "API Base URL が必要です";
        return;
      }

      statusEl.innerText = "送信中...";
      try {
        const res = await fetch(`${apiBase}/auth/callback`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: codeValue }),
        });
        const result = await res.json().catch(() => ({}));
        statusEl.innerText = `完了: ${res.status} ${JSON.stringify(result)}`;
        localStorage.setItem("tiktok_api_base", apiBase);
      } catch (err) {
        statusEl.innerText = `失敗: ${String(err)}`;
      }
    }

    if (apiParam) {
      apiInput.value = apiParam;
    }

    sendBtn.addEventListener("click", () => {
      sendCode(apiInput.value.trim());
    });
  </script>
</body>
</html>
